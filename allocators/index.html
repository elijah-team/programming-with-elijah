<!doctype html>

<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Allocators are responsible for creating and removing objects from the heap.
">
    <meta name="author" content="Tripleo">

    
        <link rel="canonical" href="https://elijah-team.github.io/programming-with-elijah/allocators/" />
    
    <link href="/programming-with-elijah/css/edition-2/poole.css" rel="stylesheet">
    <link href="/programming-with-elijah/css/edition-2/main.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="RSS feed for tripleo1.github.io/blog" href="https://elijah-team.github.io/programming-with-elijah//blog/rss.xml" />

    <script async src="/programming-with-elijah/js/edition-2/main.js"></script>

    <title>Allocators | Programming with Elijah</title>
</head>

<body>
    <div class="container content">
        <header class="masthead">
            <div style="position:relative">
                <h2 class="masthead-title">
                    <a href="https://elijah-team.github.io/programming-with-elijah/" title="Home">Programming with Elijah</a>
                </h2>
                <p><small>Programming&nbsp;with&nbsp;Elijah</small></p>
                
    <aside id="all-posts-link"><a href="https://elijah-team.github.io/programming-with-elijah/" title="All Posts">Â« All Posts</a></aside>

            </div>
        </header>

        <div>
            
<aside id="toc-aside" class="">
        <h2>Table of Contents</h2>
    <ol>
        <li>
            <a href="#introduction">Introduction</a>
            
        </li><li>
            <a href="#accessing-page-tables">Accessing Page Tables</a>
            <ol>
                <li>
                    <a href="#identity-mapping">Identity Mapping</a>
                </li><li>
                    <a href="#map-at-a-fixed-offset">Map at a Fixed Offset</a>
                </li><li>
                    <a href="#map-the-complete-physical-memory">Map the Complete Physical Memory</a>
                </li><li>
                    <a href="#temporary-mapping">Temporary Mapping</a>
                </li><li>
                    <a href="#recursive-page-tables">Recursive Page Tables</a>
                </li>
            </ol>
        </li><li>
            <a href="#summary">Summary</a>
            
        </li><li>
            <a href="#what-s-next">What's next?</a>
            
        </li>
        <li class="toc-comments-link"><a href="#comments">Comments</a></li>
    </ol>
</aside>

            <main>
    <div class="">
    <h1>Allocators</h1>
    <time datetime="2021-06-13" class="post-date">
        Jun 13, 2021
        
    </time>
    </div>

    

    <div class="">
    <p>Allocators are responsible for creating and removing objects from the heap.</p>
<span id="continue-reading"></span>
<p>This blog is openly developed on <a href="https://github.com/elijah-team/programming-with-elijah/">GitHub</a>. If you have any problems or questions, please open an issue there. You can also leave comments <a href="https://elijah-team.github.io/programming-with-elijah/allocators/#comments">at the bottom</a>. The complete source code for this post can be found in the <a href="https://elijah-team.github.io/programming-with-elijah/tree/post-09"><code>post-09</code></a> branch.</p>

    <details id = "toc-inline">
        <summary><b>Table of Contents</b></summary>
        <ul>
            <li>
                <a href="#introduction">Introduction</a>
                
            </li><li>
                <a href="#accessing-page-tables">Accessing Page Tables</a>
                <ul>
                    <li>
                        <a href="#identity-mapping">Identity Mapping</a>
                    </li><li>
                        <a href="#map-at-a-fixed-offset">Map at a Fixed Offset</a>
                    </li><li>
                        <a href="#map-the-complete-physical-memory">Map the Complete Physical Memory</a>
                    </li><li>
                        <a href="#temporary-mapping">Temporary Mapping</a>
                    </li><li>
                        <a href="#recursive-page-tables">Recursive Page Tables</a>
                    </li>
                </ul>
            </li><li>
                <a href="#summary">Summary</a>
                
            </li><li>
                <a href="#what-s-next">What's next?</a>
                
            </li>
            <li class="toc-comments-link"><a href="#comments">Comments</a></li>
        </ul>
    </details>

<h2 id="introduction"><a class="zola-anchor" href="#introduction" aria-label="Anchor link for: introduction">ðŸ”—</a>Introduction</h2>
<p>The <a href="https://elijah-team.github.io/programming-with-elijah/memory-classes/">previous post</a> gave an introduction to the concept of paging. It motivated paging by comparing it with segmentation, explained how paging and page tables work, and then introduced the 4-level page table design of <code>x86_64</code>. We found out that the bootloader already set up a page table hierarchy for our kernel, which means that our kernel already runs on virtual addresses. This improves safety since illegal memory accesses cause page fault exceptions instead of modifying arbitrary physical memory.</p>
<h2 id="accessing-page-tables"><a class="zola-anchor" href="#accessing-page-tables" aria-label="Anchor link for: accessing-page-tables">ðŸ”—</a>Accessing Page Tables</h2>
<h3 id="identity-mapping"><a class="zola-anchor" href="#identity-mapping" aria-label="Anchor link for: identity-mapping">ðŸ”—</a>Identity Mapping</h3>
<h3 id="map-at-a-fixed-offset"><a class="zola-anchor" href="#map-at-a-fixed-offset" aria-label="Anchor link for: map-at-a-fixed-offset">ðŸ”—</a>Map at a Fixed Offset</h3>
<h3 id="map-the-complete-physical-memory"><a class="zola-anchor" href="#map-the-complete-physical-memory" aria-label="Anchor link for: map-the-complete-physical-memory">ðŸ”—</a>Map the Complete Physical Memory</h3>
<h3 id="temporary-mapping"><a class="zola-anchor" href="#temporary-mapping" aria-label="Anchor link for: temporary-mapping">ðŸ”—</a>Temporary Mapping</h3>
<h3 id="recursive-page-tables"><a class="zola-anchor" href="#recursive-page-tables" aria-label="Anchor link for: recursive-page-tables">ðŸ”—</a>Recursive Page Tables</h3>
<h2 id="summary"><a class="zola-anchor" href="#summary" aria-label="Anchor link for: summary">ðŸ”—</a>Summary</h2>
<p>In this post we learned about different techniques to access the physical frames of page tables, including identity mapping, mapping of the complete physical memory, temporary mapping, and recursive page tables. We chose to map the complete physical memory since it's simple, portable, and powerful.</p>
<p>We can't map the physical memory from our kernel without page table access, so we needed support from the bootloader. The <code>bootloader</code> crate supports creating the required mapping through optional cargo features. It passes the required information to our kernel in the form of a <code>&amp;BootInfo</code> argument to our entry point function.</p>
<p>For our implementation, we first manually traversed the page tables to implement a translation function, and then used the <code>MappedPageTable</code> type of the <code>x86_64</code> crate. We also learned how to create new mappings in the page table and how to create the necessary <code>FrameAllocator</code> on top of the memory map passed by the bootloader.</p>
<h2 id="what-s-next"><a class="zola-anchor" href="#what-s-next" aria-label="Anchor link for: what-s-next">ðŸ”—</a>What's next?</h2>
<p>The next post will create a heap memory region for our kernel, which will allow us to <a href="https://doc.rust-lang.org/alloc/boxed/struct.Box.html">allocate memory</a> and use various <a href="https://doc.rust-lang.org/alloc/collections/index.html">collection types</a>.</p>

    </div>

    <div class="post-footer-support">
        <h2>Support Me</h2>
        
<p>
    Creating and <a href="https:&#x2F;&#x2F;elijah-team.github.io&#x2F;programming-with-elijah&#x2F;status-update&#x2F;">maintaining</a> this blog and the associated libraries is a lot of work, but I really enjoy doing it. By supporting me, you allow me to invest more time in new content, new features, and continuous maintenance.
</p>
<p>
    The best way to support me is to <a href="https://github.com/sponsors/phil-opp"><em>sponsor me on GitHub</em></a>, since they don't charge any fees. If you prefer other platforms, I also have <a href="https://www.patreon.com/phil_opp"><em>Patreon</em></a> and <a href="https://donorbox.org/phil-opp"><em>Donorbox</em></a> accounts. The latter is the most flexible as it supports multiple currencies and one-time contributions.
</p>
<p>
    Thank you!
</p>

    </div>

    <hr>
    <div class="PageNavigation">
        
            <a class="prev" href="/memory-classes/">&laquo; Memory Classes</a>
        
        
            <a class="next" href="/heap-allocation/">Heap Allocation &raquo;</a>
        
    </div>

    <hr>
    <section>
        <h2 id="comments" class="">Comments</h2>

        
    <script src="https://utteranc.es/client.js"
        data-repo="elijah-team/programming-with-elijah/"
        data-issue-term="url"
        data-label="comments"
        crossorigin="anonymous"
        async>
    </script>

    </section>

    <aside class="page-aside-right">
        <div class="block" id="language-selector">
            <h2>Other Languages</h2>
            <ul>
                <li data-lang-switch-to="en" class=""><a href="https://elijah-team.github.io/programming-with-elijah/allocators/">English (original)</a></li>
            </ul>
        </div>

        <div class="block">
            <h2>About Me</h2>
            <p>
		I'm just a guy who likes languages, OSes, and the intersection of the two.
            </p><p>
                If you want to work with me, reach out on <a href="mailto:remove:oluoluolu+elijah-team-github@gmail.com">E-Mail</a>.
            </p>
        </div>
    </aside>

</main>
        </div>

        <div></div>

        <footer class="footer">
            <hr>
            <small>
                &copy; <time datetime="2021">2021</time>. All rights reserved.
                <a href="https://elijah-team.github.io/programming-with-elijah/contact/">Contact</a>
            </small>
        </footer>
    </div>

    <!-- Fathom - simple website analytics - https://github.com/usefathom/fathom -->
    <script>
        (function(f, a, t, h, o, m){
            a[h]=a[h]||function(){
                (a[h].q=a[h].q||[]).push(arguments)
            };
            o=f.createElement('script'),
            m=f.getElementsByTagName('script')[0];
            o.async=1; o.src=t; o.id='fathom-script';
            m.parentNode.insertBefore(o,m)
        })(document, window, '/tracker.js', 'fathom');
        fathom('set', 'siteId', 'MUXWM');
        fathom('trackPageview');
    </script>
    <!-- / Fathom -->
</body>

</html>
OC